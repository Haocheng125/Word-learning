# 数据库初始化

<cite>
**本文档引用的文件**
- [init.sql](file://init.sql)
- [config.py](file://backend/app/config.py)
- [__init__.py](file://backend/app/__init__.py)
- [extensions.py](file://backend/app/extensions.py)
- [docker-compose.yml](file://docker-compose.yml)
- [.env.example](file://.env.example)
- [backend/.env.example](file://backend/.env.example)
- [user.py](file://backend/app/models/user.py)
- [word.py](file://backend/app/models/word.py)
- [wordbook.py](file://backend/app/models/wordbook.py)
- [user_progress.py](file://backend/app/models/user_progress.py)
- [vocabulary.py](file://backend/app/models/vocabulary.py)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概览](#架构概览)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)
10. [附录](#附录)

## 简介

本文件详细说明了单词学习网站项目的数据库初始化流程和配置。该系统采用MySQL作为主要数据库，使用Flask框架构建后端服务，并通过Docker容器化部署。本文档涵盖了从空数据库到完整可用系统的初始化步骤，包括表结构创建、索引建立、约束设置、字符集配置以及管理员账户创建等关键内容。

## 项目结构

该项目采用前后端分离架构，数据库初始化通过Docker Compose自动完成。项目的主要组成部分如下：

```mermaid
graph TB
subgraph "项目根目录"
InitSQL[init.sql<br/>数据库初始化脚本]
DockerCompose[docker-compose.yml<br/>容器编排配置]
EnvExample[.env.example<br/>环境变量示例]
end
subgraph "后端应用"
Backend[backend/]
Config[config.py<br/>数据库配置]
InitApp[__init__.py<br/>应用初始化]
Extensions[extensions.py<br/>扩展模块]
subgraph "模型层"
User[user.py<br/>用户模型]
Word[word.py<br/>单词模型]
Wordbook[wordbook.py<br/>单词书模型]
Progress[user_progress.py<br/>学习进度模型]
Vocab[vocabulary.py<br/>生词本模型]
end
end
subgraph "容器服务"
MySQL[MySQL 8.0<br/>数据库服务]
BackendService[Flask应用<br/>后端服务]
Frontend[前端应用<br/>静态资源]
end
InitSQL --> MySQL
DockerCompose --> MySQL
DockerCompose --> BackendService
DockerCompose --> Frontend
Config --> Backend
InitApp --> Backend
Extensions --> Backend
User --> Backend
Word --> Backend
Wordbook --> Backend
Progress --> Backend
Vocab --> Backend
```

**图表来源**
- [docker-compose.yml](file://docker-compose.yml#L1-L59)
- [init.sql](file://init.sql#L1-L67)
- [config.py](file://backend/app/config.py#L1-L28)

**章节来源**
- [docker-compose.yml](file://docker-compose.yml#L1-L59)
- [init.sql](file://init.sql#L1-L67)

## 核心组件

### 数据库初始化脚本

init.sql是整个系统的核心初始化文件，负责创建完整的数据库结构。该脚本包含以下关键特性：

- **数据库创建**：自动创建名为`word_learning`的数据库，使用utf8mb4字符集和unicode_ci排序规则
- **表结构定义**：定义了用户、单词书、单词、用户进度和生词本五个核心表
- **索引优化**：为常用查询字段建立索引，提升查询性能
- **约束保证**：通过外键约束和唯一约束确保数据完整性

### 数据库配置类

后端应用通过Config类集中管理数据库连接参数：

- **连接参数**：主机、端口、用户名、密码、数据库名
- **连接字符串**：使用mysql+pymysql驱动程序
- **字符集设置**：统一使用utf8mb4字符集
- **安全配置**：支持环境变量注入

**章节来源**
- [init.sql](file://init.sql#L1-L67)
- [config.py](file://backend/app/config.py#L1-L28)

## 架构概览

系统采用三层架构设计，数据库初始化通过Docker容器自动完成：

```mermaid
sequenceDiagram
participant Dev as 开发者
participant Docker as Docker Compose
participant MySQL as MySQL容器
participant InitScript as 初始化脚本
participant App as Flask应用
Dev->>Docker : 启动容器编排
Docker->>MySQL : 启动MySQL服务
MySQL->>InitScript : 执行init.sql脚本
InitScript->>MySQL : 创建数据库和表结构
InitScript->>MySQL : 建立索引和约束
MySQL-->>Docker : 初始化完成
Docker->>App : 启动Flask应用
App->>MySQL : 建立数据库连接
App->>MySQL : 验证表结构
MySQL-->>App : 连接成功
App-->>Dev : 系统就绪
```

**图表来源**
- [docker-compose.yml](file://docker-compose.yml#L1-L59)
- [init.sql](file://init.sql#L1-L67)
- [__init__.py](file://backend/app/__init__.py#L32-L35)

## 详细组件分析

### 数据库表结构设计

系统采用规范化设计，包含以下核心表：

#### 用户表 (users)
- **主键**：自增ID
- **唯一约束**：用户名和邮箱
- **索引优化**：邮箱和用户名索引
- **字段类型**：VARCHAR、BOOLEAN、DATETIME

#### 单词书表 (wordbooks)
- **主键**：自增ID
- **字段**：名称、描述、PDF文件名、单词数量
- **默认值**：word_count默认为0

#### 单词表 (words)
- **主键**：自增ID
- **外键关联**：wordbook_id指向wordbooks表
- **唯一约束**：wordbook_id+sequence组合唯一
- **索引优化**：复合索引(wordbook_id, sequence)

#### 用户进度表 (user_progress)
- **主键**：自增ID
- **外键约束**：用户ID和单词书ID
- **唯一约束**：每个用户对每本单词书的进度唯一
- **默认值**：current_index默认为1

#### 生词本表 (vocabulary)
- **主键**：自增ID
- **外键约束**：用户ID和单词ID
- **唯一约束**：用户添加的同一单词唯一

```mermaid
erDiagram
USERS {
int id PK
varchar username UK
varchar email UK
varchar password_hash
boolean is_admin
datetime created_at
}
WORDBOOKS {
int id PK
varchar name
text description
varchar pdf_filename
int word_count
datetime created_at
}
WORDS {
int id PK
int wordbook_id FK
varchar word
varchar phonetic
text translation
int sequence
datetime created_at
}
USER_PROGRESS {
int id PK
int user_id FK
int wordbook_id FK
int current_index
datetime last_learn_time
datetime created_at
}
VOCABULARY {
int id PK
int user_id FK
int word_id FK
datetime added_at
}
USERS ||--o{ USER_PROGRESS : has
USERS ||--o{ VOCABULARY : has
WORDBOOKS ||--o{ WORDS : contains
WORDBOOKS ||--o{ USER_PROGRESS : tracked_by
WORDS ||--o{ VOCABULARY : added_to
```

**图表来源**
- [user.py](file://backend/app/models/user.py#L4-L16)
- [wordbook.py](file://backend/app/models/wordbook.py#L4-L15)
- [word.py](file://backend/app/models/word.py#L4-L18)
- [user_progress.py](file://backend/app/models/user_progress.py#L4-L17)
- [vocabulary.py](file://backend/app/models/vocabulary.py#L4-L14)

**章节来源**
- [user.py](file://backend/app/models/user.py#L1-L26)
- [wordbook.py](file://backend/app/models/wordbook.py#L1-L25)
- [word.py](file://backend/app/models/word.py#L1-L29)
- [user_progress.py](file://backend/app/models/user_progress.py#L1-L29)
- [vocabulary.py](file://backend/app/models/vocabulary.py#L1-L26)

### 数据库初始化流程

系统提供了两种初始化方式：

#### 方式一：Docker自动初始化
通过Docker Compose配置，MySQL容器启动时自动执行init.sql脚本：

1. **容器启动**：MySQL 8.0容器启动
2. **脚本挂载**：init.sql文件挂载到/docker-entrypoint-initdb.d/
3. **自动执行**：容器检测到初始化脚本自动执行
4. **数据库创建**：创建word_learning数据库
5. **表结构创建**：按顺序创建所有表
6. **索引建立**：自动建立所有索引
7. **约束设置**：应用所有外键和唯一约束

#### 方式二：手动初始化
适用于开发环境或需要自定义配置的情况：

1. **环境准备**：安装MySQL 8.0+
2. **配置设置**：设置数据库连接参数
3. **脚本执行**：运行init.sql文件
4. **验证检查**：确认所有表和索引创建成功

**章节来源**
- [docker-compose.yml](file://docker-compose.yml#L13-L15)
- [init.sql](file://init.sql#L1-L67)

### 数据库连接配置

系统支持多种配置方式：

#### 环境变量配置
- **后端环境变量**：位于backend/.env.example
- **根目录环境变量**：位于.env.example
- **敏感信息**：数据库密码、密钥等

#### Flask配置类
- **连接字符串格式**：mysql+pymysql://user:password@host:port/database?charset=utf8mb4
- **字符集设置**：统一使用utf8mb4
- **安全配置**：支持环境变量覆盖

#### Docker配置
- **服务依赖**：后端服务依赖MySQL健康状态
- **网络配置**：容器间通过服务名通信
- **卷挂载**：持久化存储配置

**章节来源**
- [config.py](file://backend/app/config.py#L14-L17)
- [docker-compose.yml](file://docker-compose.yml#L29-L36)
- [.env.example](file://.env.example#L1-L10)
- [backend/.env.example](file://backend/.env.example#L1-L9)

## 依赖关系分析

系统各组件之间的依赖关系如下：

```mermaid
graph TD
subgraph "配置层"
ConfigPy[config.py<br/>数据库配置]
EnvExample[.env.example<br/>环境变量]
end
subgraph "应用层"
InitPy[__init__.py<br/>应用初始化]
ExtensionsPy[extensions.py<br/>扩展模块]
end
subgraph "模型层"
UserModel[user.py<br/>用户模型]
WordModel[word.py<br/>单词模型]
WordbookModel[wordbook.py<br/>单词书模型]
ProgressModel[user_progress.py<br/>进度模型]
VocabModel[vocabulary.py<br/>生词本模型]
end
subgraph "基础设施"
InitSQL[init.sql<br/>初始化脚本]
DockerCompose[docker-compose.yml<br/>容器配置]
end
ConfigPy --> InitPy
EnvExample --> ConfigPy
InitPy --> ExtensionsPy
ExtensionsPy --> UserModel
ExtensionsPy --> WordModel
ExtensionsPy --> WordbookModel
ExtensionsPy --> ProgressModel
ExtensionsPy --> VocabModel
InitSQL --> DockerCompose
DockerCompose --> InitPy
```

**图表来源**
- [config.py](file://backend/app/config.py#L1-L28)
- [__init__.py](file://backend/app/__init__.py#L1-L37)
- [extensions.py](file://backend/app/extensions.py#L1-L10)
- [init.sql](file://init.sql#L1-L67)
- [docker-compose.yml](file://docker-compose.yml#L1-L59)

**章节来源**
- [config.py](file://backend/app/config.py#L1-L28)
- [__init__.py](file://backend/app/__init__.py#L1-L37)
- [extensions.py](file://backend/app/extensions.py#L1-L10)

## 性能考虑

### 字符集和排序规则
- **字符集选择**：使用utf8mb4支持完整的Unicode字符
- **排序规则**：采用utf8mb4_unicode_ci提供准确的排序规则
- **兼容性**：确保与前端JavaScript处理的Unicode字符兼容

### 索引优化策略
- **主键索引**：所有表的主键自动建立索引
- **唯一索引**：用户名、邮箱、组合唯一约束
- **查询优化**：为高频查询字段建立复合索引

### 外键约束设计
- **级联删除**：单词随单词书删除而删除
- **数据一致性**：通过外键约束保证引用完整性
- **性能影响**：外键检查可能影响写入性能

## 故障排除指南

### 常见初始化问题

#### 数据库连接失败
**症状**：应用启动时报数据库连接错误
**解决方案**：
1. 检查MySQL容器是否正常运行
2. 验证环境变量配置
3. 确认防火墙设置
4. 检查MySQL服务日志

#### 表结构不匹配
**症状**：应用启动时报表结构错误
**解决方案**：
1. 删除现有数据库重新初始化
2. 检查init.sql脚本语法
3. 验证MySQL版本兼容性

#### 字符集问题
**症状**：中文显示乱码
**解决方案**：
1. 确认数据库字符集设置
2. 检查连接字符串中的charset参数
3. 验证客户端字符集配置

### 调试方法

#### 日志检查
- **MySQL日志**：查看容器日志了解初始化过程
- **应用日志**：检查Flask应用的数据库连接日志
- **Docker日志**：监控容器启动过程

#### 数据库验证
- **表结构验证**：使用SHOW CREATE TABLE检查表定义
- **索引验证**：使用SHOW INDEX检查索引创建情况
- **约束验证**：使用INFORMATION_SCHEMA检查约束

**章节来源**
- [docker-compose.yml](file://docker-compose.yml#L18-L21)
- [config.py](file://backend/app/config.py#L14-L17)

## 结论

该单词学习网站项目的数据库初始化系统设计合理，采用了现代化的容器化部署方式。通过Docker Compose自动执行init.sql脚本，确保了开发环境和生产环境的一致性。系统使用utf8mb4字符集支持完整的Unicode字符，建立了完善的索引和约束体系，保证了数据的完整性和查询性能。

推荐的最佳实践包括：
- 使用Docker容器化部署确保环境一致性
- 定期备份数据库防止数据丢失
- 在生产环境中使用强密码和安全配置
- 监控数据库性能指标及时优化

## 附录

### 环境配置对比

#### 开发环境配置
- **数据库地址**：localhost
- **端口**：3307（映射到容器3306）
- **用户名**：root
- **密码**：可从环境变量读取
- **数据库名**：word_learning

#### 生产环境配置
- **数据库地址**：专用数据库服务器
- **端口**：3306
- **用户名**：专用数据库用户
- **密码**：强密码
- **数据库名**：生产数据库名

### 备份和恢复策略

#### 备份策略
- **定期备份**：每日增量备份，每周全量备份
- **备份格式**：使用mysqldump导出SQL文件
- **存储位置**：云存储或本地安全存储
- **压缩加密**：备份文件进行压缩和加密

#### 恢复流程
1. **停止应用**：暂停所有应用服务
2. **恢复数据库**：导入备份文件
3. **验证数据**：检查数据完整性和一致性
4. **重启应用**：启动应用服务
5. **监控验证**：监控系统运行状态