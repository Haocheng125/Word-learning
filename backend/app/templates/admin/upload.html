{% extends "admin/base.html" %}

{% block title %}ä¸Šä¼  Excel{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h1>ğŸ“¤ ä¸Šä¼  Excel è¯åº“</h1>
    <a href="/admin/wordbooks" class="btn">è¿”å›è¯åº“åˆ—è¡¨</a>
</div>

<div class="card">
    <form id="uploadForm" enctype="multipart/form-data">
        <div class="form-group">
            <label for="name">è¯åº“åç§° *</label>
            <input type="text" id="name" name="name" required placeholder="ä¾‹å¦‚ï¼šå¤§å­¦è‹±è¯­å››çº§è¯æ±‡">
        </div>
        
        <div class="form-group">
            <label for="description">æè¿°</label>
            <textarea id="description" name="description" rows="3" placeholder="ç®€å•æè¿°è¿™ä¸ªè¯åº“çš„å†…å®¹å’Œç”¨é€”"></textarea>
        </div>
        
        <div class="form-group">
            <label for="excel_file">é€‰æ‹© Excel æ–‡ä»¶ *</label>
            <input type="file" id="excel_file" name="excel_file" accept=".xlsx,.xls" required>
            <small style="color: #7f8c8d; display: block; margin-top: 0.5rem;">
                æ”¯æŒ .xlsx å’Œ .xls æ ¼å¼ï¼Œç¬¬ä¸€åˆ—ä¸ºè‹±æ–‡å•è¯ï¼Œç¬¬äºŒåˆ—ä¸ºä¸­æ–‡é‡Šä¹‰
            </small>
        </div>
        
        <div id="progress" style="display: none; margin: 1rem 0;">
            <div style="background: #ecf0f1; border-radius: 4px; overflow: hidden;">
                <div id="progressBar" style="background: #3498db; height: 30px; width: 0%; transition: width 0.3s; text-align: center; line-height: 30px; color: white;">
                    0%
                </div>
            </div>
            <p id="statusText" style="margin-top: 0.5rem; color: #7f8c8d;">æ­£åœ¨ä¸Šä¼ ...</p>
        </div>
        
        <button type="submit" class="btn btn-success" id="submitBtn">å¼€å§‹ä¸Šä¼ å¹¶è§£æ</button>
    </form>
</div>

<div class="card">
    <h2>ğŸ“‹ ä½¿ç”¨è¯´æ˜</h2>
    <ul style="line-height: 2;">
        <li>æ”¯æŒä¸Šä¼  Excel æ–‡ä»¶ï¼ˆ.xlsx æˆ– .xlsï¼‰</li>
        <li>ç¬¬ä¸€åˆ—ï¼šè‹±æ–‡å•è¯ï¼ˆWordï¼‰</li>
        <li>ç¬¬äºŒåˆ—ï¼šä¸­æ–‡é‡Šä¹‰ï¼ˆMeaningï¼‰</li>
        <li>ç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«è¡¨å¤´ï¼ˆå¦‚æœæœ‰ï¼‰</li>
        <li>æ–‡ä»¶å¤§å°é™åˆ¶ï¼š50MB</li>
        <li>ä¸Šä¼ åä¼šè‡ªåŠ¨æ˜¾ç¤ºè§£æç»“æœ</li>
    </ul>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('uploadForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const name = document.getElementById('name').value.trim();
    const description = document.getElementById('description').value.trim();
    const fileInput = document.getElementById('excel_file');
    const file = fileInput.files[0];
    
    if (!name || !file) {
        alert('è¯·å¡«å†™è¯åº“åç§°å¹¶é€‰æ‹© Excel æ–‡ä»¶');
        return;
    }
    
    const formData = new FormData();
    formData.append('name', name);
    formData.append('description', description);
    formData.append('excel_file', file);
    
    // æ˜¾ç¤ºè¿›åº¦æ¡
    document.getElementById('progress').style.display = 'block';
    document.getElementById('submitBtn').disabled = true;
    document.getElementById('submitBtn').textContent = 'ä¸Šä¼ ä¸­...';
    
    // æ¨¡æ‹Ÿè¿›åº¦æ¡åŠ¨ç”»
    let progress = 0;
    const progressInterval = setInterval(() => {
        if (progress < 90) {
            progress += Math.random() * 10;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressBar').textContent = Math.floor(progress) + '%';
        }
    }, 500);
    
    try {
        const response = await fetch('/admin/api/upload-excel', {
            method: 'POST',
            body: formData
        });
        
        clearInterval(progressInterval);
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('progressBar').style.width = '100%';
            document.getElementById('progressBar').textContent = '100%';
            document.getElementById('statusText').textContent = `âœ… ${data.message}`;
            document.getElementById('statusText').style.color = '#27ae60';
            
            alert(`ä¸Šä¼ æˆåŠŸï¼å…±å¯¼å…¥ ${data.word_count} ä¸ªå•è¯\nè¯åº“å·²åˆ›å»ºï¼Œé»˜è®¤ä¸ºä¸‹æ¶çŠ¶æ€ï¼Œè¯·åœ¨è¯åº“åˆ—è¡¨ä¸­æ‰‹åŠ¨ä¸Šæ¶`);
            setTimeout(() => {
                window.location.href = '/admin/wordbooks';
            }, 1500);
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        clearInterval(progressInterval);
        document.getElementById('statusText').textContent = 'âŒ ' + error.message;
        document.getElementById('statusText').style.color = '#e74c3c';
        document.getElementById('submitBtn').disabled = false;
        document.getElementById('submitBtn').textContent = 'å¼€å§‹ä¸Šä¼ å¹¶è§£æ';
        alert('ä¸Šä¼ å¤±è´¥ï¼š' + error.message);
    }
});
</script>
{% endblock %}
