{% extends "admin/base.html" %}

{% block title %}{{ wordbook.name }} - å•è¯åˆ—è¡¨{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <div>
        <h1>ğŸ“š {{ wordbook.name }}</h1>
        <p style="color: #666; margin-top: 0.5rem;">
            å…± {{ words|length }} ä¸ªå•è¯ | 
            çŠ¶æ€: {% if wordbook.is_active %}âœ… å·²ä¸Šæ¶{% else %}âŒ å·²ä¸‹æ¶{% endif %}
        </p>
    </div>
    <div>
        <a href="/admin/wordbooks" class="btn">è¿”å›è¯åº“åˆ—è¡¨</a>
        <a href="/admin/wordbooks/{{ wordbook.id }}/toggle" 
           class="btn" 
           style="background: {% if wordbook.is_active %}#e67e22{% else %}#27ae60{% endif %}; margin-left: 10px;"
           onclick="toggleStatus(event, {{ wordbook.id }}, {{ wordbook.is_active|lower }})">
            {% if wordbook.is_active %}ğŸ”» ä¸‹æ¶{% else %}ğŸ”º ä¸Šæ¶{% endif %}
        </a>
    </div>
</div>

<div class="card">
    {% if words %}
    <div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
        <h3>å•è¯åˆ—è¡¨</h3>
        <div>
            <button class="btn" style="background: #27ae60; margin-right: 10px;" onclick="showAddWordForm()">â• æ·»åŠ å•è¯</button>
            {% if wordbook.excel_path %}
            <a href="{{ wordbook.excel_path }}" class="btn" style="background: #f39c12; margin-right: 10px;">ğŸ“¥ ä¸‹è½½è½¬æ¢Excel</a>
            {% endif %}
            <button id="exportBtn" class="btn" onclick="exportToExcel()" style="background: #3498db;" disabled>ğŸ“¤ å¯¼å‡ºå½“å‰åˆ—è¡¨</button>
        </div>
    </div>
    
    <!-- æ·»åŠ å•è¯è¡¨å• -->
    <div id="addWordForm" class="card" style="display: none; margin-bottom: 2rem; background: #f8f9fa;">
        <h4 style="margin-bottom: 1rem;">â• æ·»åŠ æ–°å•è¯</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr 2fr; gap: 1rem; margin-bottom: 1rem;">
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">è‹±æ–‡å•è¯ *</label>
                <input type="text" id="newWord" placeholder="è¯·è¾“å…¥è‹±æ–‡å•è¯" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">éŸ³æ ‡</label>
                <input type="text" id="newPhonetic" placeholder="è¯·è¾“å…¥éŸ³æ ‡ï¼ˆå¯é€‰ï¼‰" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">ä¸­æ–‡ç¿»è¯‘ *</label>
                <input type="text" id="newTranslation" placeholder="è¯·è¾“å…¥ä¸­æ–‡ç¿»è¯‘" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
        </div>
        <div style="display: flex; gap: 1rem;">
            <button class="btn" style="background: #27ae60;" onclick="addWord()">âœ… ç¡®è®¤æ·»åŠ </button>
            <button class="btn" style="background: #95a5a6;" onclick="hideAddWordForm()">âŒ å–æ¶ˆ</button>
        </div>
    </div>
    
    <div style="overflow-x: auto;">
        <table style="min-width: 800px;">
            <thead>
                <tr>
                    <th style="width: 60px;">åºå·</th>
                    <th style="width: 150px;">è‹±æ–‡å•è¯</th>
                    <th style="width: 150px;">éŸ³æ ‡</th>
                    <th>ä¸­æ–‡ç¿»è¯‘</th>
                    <th style="width: 120px;">åˆ›å»ºæ—¶é—´</th>
                </tr>
            </thead>
            <tbody>
                {% for word in words %}
                <tr>
                    <td style="text-align: center; font-weight: bold;">{{ word.sort_order }}</td>
                    <td style="font-weight: bold; color: #2c3e50;">{{ word.word }}</td>
                    <td style="color: #7f8c8d;">{{ word.phonetic or '-' }}</td>
                    <td>{{ word.translation }}</td>
                    <td style="color: #95a5a6; font-size: 0.9em;">
                        {{ word.created_at.strftime('%Y-%m-%d') if word.created_at else '-' }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
        <h4>ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 0.5rem;">
            <div>
                <strong>æ€»å•è¯æ•°:</strong> {{ words|length }}
            </div>
            <div>
                <strong>æœ‰éŸ³æ ‡:</strong> {{ words|selectattr('phonetic')|list|length }}
            </div>
            <div>
                <strong>åˆ›å»ºæ—¶é—´:</strong> {{ wordbook.created_at.strftime('%Y-%m-%d %H:%M') }}
            </div>
        </div>
    </div>
    
    {% else %}
    <div style="text-align: center; padding: 3rem;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“</div>
        <h3>æš‚æ— å•è¯æ•°æ®</h3>
        <p style="color: #666;">è¯¥è¯åº“ä¸­è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•å•è¯</p>
        <a href="/admin/upload" class="btn btn-success" style="margin-top: 1rem;">ä¸Šä¼ å•è¯æ•°æ®</a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<!-- åŠ è½½SheetJSåº“ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
// åº“åŠ è½½å®Œæˆåå¯ç”¨å¯¼å‡ºæŒ‰é’®
window.onload = function() {
    const exportBtn = document.getElementById('exportBtn');
    if (exportBtn) {
        exportBtn.disabled = false;
    }
};

function showAddWordForm() {
    document.getElementById('addWordForm').style.display = 'block';
}

function hideAddWordForm() {
    document.getElementById('addWordForm').style.display = 'none';
    document.getElementById('newWord').value = '';
    document.getElementById('newPhonetic').value = '';
    document.getElementById('newTranslation').value = '';
}

function addWord() {
    const word = document.getElementById('newWord').value.trim();
    const phonetic = document.getElementById('newPhonetic').value.trim();
    const translation = document.getElementById('newTranslation').value.trim();
    
    if (!word || !translation) {
        alert('è¯·å¡«å†™å•è¯å’Œä¸­æ–‡ç¿»è¯‘ï¼');
        return;
    }
    
    fetch('/admin/api/wordbooks/{{ wordbook.id }}/words', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            word: word,
            phonetic: phonetic,
            translation: translation
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('æ·»åŠ å¤±è´¥ï¼š' + data.message);
        }
    })
    .catch(err => {
        alert('æ·»åŠ å¤±è´¥ï¼š' + err.message);
    });
}

function toggleStatus(event, id, currentStatus) {
    event.preventDefault();
    const action = currentStatus ? 'ä¸‹æ¶' : 'ä¸Šæ¶';
    if (!confirm(`ç¡®å®šè¦${action}æ­¤è¯åº“å—ï¼Ÿ`)) {
        return;
    }
    
    fetch(`/admin/api/wordbooks/${id}/toggle`, {
        method: 'POST'
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('æ“ä½œå¤±è´¥ï¼š' + data.message);
        }
    })
    .catch(err => {
        alert('æ“ä½œå¤±è´¥ï¼š' + err.message);
    });
}

function exportToExcel() {
    // åˆ›å»ºExcelæ•°æ®
    const data = [
        ['åºå·', 'è‹±æ–‡å•è¯', 'éŸ³æ ‡', 'ä¸­æ–‡ç¿»è¯‘']
    ];
    
    // æ·»åŠ å•è¯æ•°æ®
    {% for word in words %}
    data.push([
        {{ word.sort_order }},
        "{{ word.word | replace('"', '\\"') }}",
        "{{ (word.phonetic or '') | replace('"', '\\"') }}",
        "{{ word.translation | replace('"', '\\"') }}"
    ]);
    {% endfor %}
    
    // åˆ›å»ºå·¥ä½œç°¿
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "å•è¯åˆ—è¡¨");
    
    // å¯¼å‡ºæ–‡ä»¶
    const filename = "{{ wordbook.name | replace('"', '_') }}_å•è¯åˆ—è¡¨.xlsx";
    XLSX.writeFile(wb, filename);
}
</script>
{% endblock %}
