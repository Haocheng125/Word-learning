{% extends "admin/base.html" %}

{% block title %}{{ wordbook.name }} - å•è¯åˆ—è¡¨{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <div>
        <h1>ğŸ“š {{ wordbook.name }}</h1>
        <p style="color: #666; margin-top: 0.5rem;">
            å…± {{ words|length }} ä¸ªå•è¯ | 
            çŠ¶æ€: {% if wordbook.is_active %}âœ… å·²ä¸Šæ¶{% else %}âŒ å·²ä¸‹æ¶{% endif %}
        </p>
    </div>
    <div>
        <a href="/admin/wordbooks" class="btn">è¿”å›è¯åº“åˆ—è¡¨</a>
        <a href="/admin/wordbooks/{{ wordbook.id }}/toggle" 
           class="btn" 
           style="background: {% if wordbook.is_active %}#e67e22{% else %}#27ae60{% endif %}; margin-left: 10px;"
           onclick="toggleStatus(event, {{ wordbook.id }}, {{ wordbook.is_active|lower }})">
            {% if wordbook.is_active %}ğŸ”» ä¸‹æ¶{% else %}ğŸ”º ä¸Šæ¶{% endif %}
        </a>
    </div>
</div>

<div class="card">
    {% if words %}
    <div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
        <h3>å•è¯åˆ—è¡¨</h3>
        <div>
            <button class="btn" onclick="exportToExcel()" style="background: #3498db;">ğŸ“¥ å¯¼å‡ºExcel</button>
        </div>
    </div>
    
    <div style="overflow-x: auto;">
        <table style="min-width: 800px;">
            <thead>
                <tr>
                    <th style="width: 60px;">åºå·</th>
                    <th style="width: 150px;">è‹±æ–‡å•è¯</th>
                    <th style="width: 150px;">éŸ³æ ‡</th>
                    <th>ä¸­æ–‡ç¿»è¯‘</th>
                    <th style="width: 120px;">åˆ›å»ºæ—¶é—´</th>
                </tr>
            </thead>
            <tbody>
                {% for word in words %}
                <tr>
                    <td style="text-align: center; font-weight: bold;">{{ word.sequence }}</td>
                    <td style="font-weight: bold; color: #2c3e50;">{{ word.word }}</td>
                    <td style="color: #7f8c8d;">{{ word.phonetic or '-' }}</td>
                    <td>{{ word.translation }}</td>
                    <td style="color: #95a5a6; font-size: 0.9em;">
                        {{ word.created_at.strftime('%Y-%m-%d') if word.created_at else '-' }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
        <h4>ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 0.5rem;">
            <div>
                <strong>æ€»å•è¯æ•°:</strong> {{ words|length }}
            </div>
            <div>
                <strong>æœ‰éŸ³æ ‡:</strong> {{ words|selectattr('phonetic')|list|length }}
            </div>
            <div>
                <strong>åˆ›å»ºæ—¶é—´:</strong> {{ wordbook.created_at.strftime('%Y-%m-%d %H:%M') }}
            </div>
        </div>
    </div>
    
    {% else %}
    <div style="text-align: center; padding: 3rem;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“</div>
        <h3>æš‚æ— å•è¯æ•°æ®</h3>
        <p style="color: #666;">è¯¥è¯åº“ä¸­è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•å•è¯</p>
        <a href="/admin/upload" class="btn btn-success" style="margin-top: 1rem;">ä¸Šä¼ å•è¯æ•°æ®</a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleStatus(event, id, currentStatus) {
    event.preventDefault();
    const action = currentStatus ? 'ä¸‹æ¶' : 'ä¸Šæ¶';
    if (!confirm(`ç¡®å®šè¦${action}æ­¤è¯åº“å—ï¼Ÿ`)) {
        return;
    }
    
    fetch(`/admin/api/wordbooks/${id}/toggle`, {
        method: 'POST'
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('æ“ä½œå¤±è´¥ï¼š' + data.message);
        }
    })
    .catch(err => {
        alert('æ“ä½œå¤±è´¥ï¼š' + err.message);
    });
}

function exportToExcel() {
    // åˆ›å»ºExcelæ•°æ®
    const data = [
        ['åºå·', 'è‹±æ–‡å•è¯', 'éŸ³æ ‡', 'ä¸­æ–‡ç¿»è¯‘']
    ];
    
    // æ·»åŠ å•è¯æ•°æ®
    {% for word in words %}
    data.push([
        '{{ word.sequence }}',
        '{{ word.word }}',
        '{{ word.phonetic or "" }}',
        '{{ word.translation }}'
    ]);
    {% endfor %}
    
    // åˆ›å»ºå·¥ä½œç°¿
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "å•è¯åˆ—è¡¨");
    
    // å¯¼å‡ºæ–‡ä»¶
    XLSX.writeFile(wb, "{{ wordbook.name }}_å•è¯åˆ—è¡¨.xlsx");
}

// åŠ è½½SheetJSåº“
const script = document.createElement('script');
script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
script.onload = function() {
    // åº“åŠ è½½å®Œæˆåå¯ç”¨å¯¼å‡ºæŒ‰é’®
    document.querySelector('[onclick="exportToExcel()"]').disabled = false;
};
document.head.appendChild(script);
</script>
{% endblock %}